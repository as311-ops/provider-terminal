<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROVIDER Pipeline â€” Compact</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
<style>
:root {
    --bg: #0a0c10;
    --s1: #12151c;
    --s2: #1a1e28;
    --s3: #222836;
    --bd: #2a3040;
    --tx: #e2e5ee;
    --dim: #6b7394;
    --acc: #6366f1;
    --grn: #10b981;
    --ylw: #f59e0b;
    --org: #f97316;
    --red: #ef4444;
    --cyn: #06b6d4;
    --pnk: #ec4899;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'SF Mono','Fira Code','JetBrains Mono',monospace; background:var(--bg); color:var(--tx); font-size:11px; overflow-x:hidden; }

/* â”€â”€â”€ APP SHELL â”€â”€â”€ */
.app { display:grid; grid-template-rows:auto auto 1fr auto; height:100vh; max-width:1800px; margin:0 auto; padding:8px 12px; gap:6px; }

/* â”€â”€â”€ HEADER BAR: title + KPIs + controls in ONE row â”€â”€â”€ */
.hdr { display:flex; align-items:center; gap:12px; flex-wrap:wrap; padding:4px 0; }
.hdr-title { font-size:13px; font-weight:700; white-space:nowrap; }
.hdr-title b { background:linear-gradient(135deg,var(--red),var(--org)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.hdr-dot { width:6px;height:6px;border-radius:50%;display:inline-block;margin:0 3px; animation:blink 1.5s ease-in-out infinite; }
.hdr-dot.live { background:var(--grn); }
.hdr-dot.paused { background:var(--ylw); animation:none; }
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.hdr-kpis { display:flex; gap:2px; flex:1; }
.hk { padding:3px 10px; border-radius:4px; background:var(--s1); border:1px solid var(--bd); display:flex; align-items:center; gap:6px; white-space:nowrap; }
.hk-l { font-size:9px; text-transform:uppercase; letter-spacing:.08em; color:var(--dim); }
.hk-v { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.hk-s { font-size:9px; color:var(--dim); }

.hdr-ctrl { display:flex; gap:4px; margin-left:auto; }
.hdr-ctrl button { background:var(--s2); border:1px solid var(--bd); color:var(--tx); padding:3px 10px; border-radius:4px; font-size:10px; font-family:inherit; cursor:pointer; }
.hdr-ctrl button:hover { border-color:var(--acc); }
.hdr-ctrl button.on { background:var(--acc); border-color:var(--acc); }

/* â”€â”€â”€ ALERT TICKER â”€â”€â”€ */
.ticker { display:flex; align-items:center; gap:8px; min-height:18px; font-size:10px; overflow:hidden; padding:2px 6px; border-radius:4px; }
.ticker.has-crit { background:#ef444418; border:1px solid #ef444444; color:#fca5a5; }
.ticker.has-warn { background:#f59e0b12; border:1px solid #f59e0b33; color:#fcd34d; }
.ticker.has-info { background:var(--s1); border:1px solid var(--bd); color:var(--dim); }
.ticker:empty { display:none; }
.ticker-icon { flex-shrink:0; }
.ticker-msgs { flex:1; overflow:hidden; }
.ticker-msg { display:inline; }
.ticker-msg + .ticker-msg::before { content:' â”‚ '; color:var(--dim); }
.ticker-dismiss { background:none; border:none; color:inherit; cursor:pointer; opacity:.5; font-size:13px; }
.ticker-dismiss:hover { opacity:1; }

/* â”€â”€â”€ MAIN: 3-column layout â”€â”€â”€ */
.main { display:grid; grid-template-columns:1fr 300px; gap:6px; min-height:0; overflow:hidden; }
@media(max-width:1000px){ .main{grid-template-columns:1fr;} }

/* â”€â”€â”€ MARKET TABLE â”€â”€â”€ */
.tbl-wrap { overflow-y:auto; min-height:0; }
.tbl-wrap::-webkit-scrollbar { width:3px; }
.tbl-wrap::-webkit-scrollbar-thumb { background:var(--bd); border-radius:2px; }

table.mtbl { width:100%; border-collapse:separate; border-spacing:0; }
table.mtbl th { position:sticky; top:0; z-index:2; background:var(--s1); font-size:9px; text-transform:uppercase; letter-spacing:.08em; color:var(--dim); padding:4px 6px; text-align:left; border-bottom:1px solid var(--bd); font-weight:600; }
table.mtbl th.r, table.mtbl td.r { text-align:right; }
table.mtbl td { padding:4px 6px; border-bottom:1px solid #1a1e2888; vertical-align:middle; white-space:nowrap; }
table.mtbl tr { transition:background .15s; }
table.mtbl tr:hover { background:var(--s2); }
table.mtbl tr.row-crit { background:#ef444410; }
table.mtbl tr.row-warn { background:#f59e0b08; }
table.mtbl tr.row-crit:hover { background:#ef444418; }
table.mtbl tr.row-warn:hover { background:#f59e0b12; }

.type-tag { font-size:9px; padding:1px 5px; border-radius:3px; text-transform:uppercase; letter-spacing:.04em; font-weight:600; white-space:nowrap; }
.q-text { max-width:320px; overflow:hidden; text-overflow:ellipsis; font-size:11px; }
.prob-val { font-size:14px; font-weight:700; font-variant-numeric:tabular-nums; }
.chg { font-size:10px; font-weight:600; }
.chg.up { color:var(--red); }
.chg.dn { color:var(--grn); }
.chg.fl { color:var(--dim); }
.trend-pill { font-size:8px; padding:1px 5px; border-radius:3px; font-weight:700; letter-spacing:.04em; }
.t-rising { background:#ef444422; color:#fca5a5; }
.t-falling { background:#10b98122; color:#6ee7b7; }
.t-stable { background:var(--s3); color:var(--dim); }
.t-volatile { background:#f59e0b22; color:#fcd34d; }
.spark { display:flex; align-items:flex-end; gap:1px; height:18px; }
.spark .b { width:2px; border-radius:1px; }
.minmax { font-size:9px; color:var(--dim); font-variant-numeric:tabular-nums; }

/* â”€â”€â”€ RIGHT PANEL: Scenarios + Alert Log â”€â”€â”€ */
.rpanel { display:flex; flex-direction:column; gap:6px; min-height:0; overflow:hidden; }

/* Scenario Impact (compact) */
.sc-box { background:var(--s1); border:1px solid var(--bd); border-radius:6px; padding:8px 10px; flex-shrink:0; }
.sc-hdr { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
.sc-hdr h3 { font-size:11px; font-weight:700; }
.sc-hdr .badge { font-size:8px; padding:1px 6px; border-radius:8px; background:var(--acc); color:white; font-weight:600; }
.sc-hdr .reason { font-size:9px; color:var(--dim); margin-left:auto; }

.sc-sev-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.sc-gauge { flex-shrink:0; }
.sc-gauge canvas { width:80px!important; height:50px!important; }
.sc-nums { display:flex; gap:12px; }
.sc-num { display:flex; flex-direction:column; align-items:center; }
.sc-num .lbl { font-size:8px; color:var(--dim); text-transform:uppercase; }
.sc-num .val { font-size:16px; font-weight:700; font-variant-numeric:tabular-nums; }

/* Impact bars mini */
.ib-mini { display:flex; flex-direction:column; gap:2px; margin-bottom:6px; }
.ib-mini h4 { font-size:8px; text-transform:uppercase; letter-spacing:.08em; color:var(--dim); margin-bottom:1px; }
.ibm-row { display:flex; align-items:center; gap:4px; height:14px; }
.ibm-lbl { flex:0 0 90px; text-align:right; font-size:9px; color:var(--dim); overflow:hidden; text-overflow:ellipsis; }
.ibm-track { flex:1; height:8px; background:var(--bg); border-radius:2px; overflow:hidden; position:relative; }
.ibm-fill { height:100%; border-radius:2px; }
.ibm-fill-o { position:absolute; top:0; height:100%; border-radius:2px; opacity:.35; }
.ibm-val { flex:0 0 36px; text-align:right; font-size:9px; font-weight:600; font-variant-numeric:tabular-nums; }

/* Disruption frequency mini */
.df-mini { display:flex; flex-wrap:wrap; gap:3px; margin-bottom:6px; }
.df-mini h4 { font-size:8px; text-transform:uppercase; letter-spacing:.08em; color:var(--dim); width:100%; margin-bottom:0; }
.df-chip { font-size:9px; padding:2px 6px; border-radius:3px; font-weight:600; display:flex; gap:4px; align-items:center; }
.df-chip .pct { font-variant-numeric:tabular-nums; }

/* Stress strip mini */
.stress-mini { display:flex; gap:4px; overflow-x:auto; padding-bottom:2px; }
.stress-mini::-webkit-scrollbar { height:2px; }
.stress-mini::-webkit-scrollbar-thumb { background:var(--bd); }
.sm-card { flex:0 0 140px; background:var(--s2); border:1px solid var(--bd); border-radius:4px; padding:5px 7px; font-size:9px; }
.sm-card .sev { font-size:12px; font-weight:700; }
.sm-card .tags { display:flex; flex-wrap:wrap; gap:2px; margin:2px 0; }
.sm-card .tags span { font-size:7px; padding:0 4px; border-radius:2px; }
.sm-card .evts { color:var(--dim); line-height:1.3; font-size:8px; }

/* â”€â”€â”€ Alert log (compact) â”€â”€â”€ */
.alog { flex:1; overflow-y:auto; min-height:0; }
.alog::-webkit-scrollbar { width:3px; }
.alog::-webkit-scrollbar-thumb { background:var(--bd); border-radius:2px; }
.alog-hdr { display:flex; align-items:center; gap:6px; position:sticky; top:0; background:var(--bg); z-index:1; padding:2px 0; margin-bottom:2px; }
.alog-hdr h3 { font-size:10px; font-weight:700; }
.alog-cnt { font-size:8px; padding:1px 6px; border-radius:8px; font-weight:700; }

.al-item { padding:4px 6px; border-left:2px solid var(--bd); margin-bottom:2px; border-radius:0 3px 3px 0; font-size:10px; background:var(--s1); }
.al-item.critical { border-left-color:var(--red); background:#ef444412; }
.al-item.warning { border-left-color:var(--ylw); background:#f59e0b0a; }
.al-item.info { border-left-color:var(--cyn); }
.al-top { display:flex; gap:6px; align-items:center; }
.al-time { font-size:8px; color:var(--dim); }
.al-type { font-size:7px; text-transform:uppercase; letter-spacing:.06em; font-weight:700; }
.al-msg { margin-top:1px; line-height:1.3; }
.al-mkt { font-size:8px; color:var(--dim); font-style:italic; margin-top:1px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:270px; }

/* â”€â”€â”€ Footer â”€â”€â”€ */
footer { text-align:center; font-size:8px; color:var(--dim); padding:2px 0; }
</style>
</head>
<body>
<div class="app">

<!-- â•â•â• HEADER: Title + KPIs + Controls â•â•â• -->
<div class="hdr">
    <span class="hdr-title"><b>PROVIDER</b> Pipeline</span>
    <span><span class="hdr-dot live" id="hDot"></span><span id="hStatus" style="font-size:9px;color:var(--dim)">LIVE</span></span>
    <span style="font-size:9px;color:var(--dim)">Poll #<span id="hPoll">0</span> Â· <span id="hTime">--:--</span></span>

    <div class="hdr-kpis" id="kpiBar">
        <div class="hk"><span class="hk-l">Status</span><span class="hk-v" id="kStat">â€”</span></div>
        <div class="hk"><span class="hk-l">MÃ¤rkte</span><span class="hk-v" id="kMkt">12</span><span class="hk-s" id="kRise">0â†‘</span></div>
        <div class="hk"><span class="hk-l">Max P</span><span class="hk-v" id="kMax">â€”</span></div>
        <div class="hk"><span class="hk-l">Alerts</span><span class="hk-v" id="kAlerts">0</span></div>
    </div>

    <div class="hdr-ctrl">
        <button id="btnP" onclick="togglePause()">â¸</button>
        <button onclick="setSpeed(1)">1Ã—</button>
        <button class="on" onclick="setSpeed(3)">3Ã—</button>
        <button onclick="setSpeed(10)">10Ã—</button>
    </div>
</div>

<!-- â•â•â• ALERT TICKER â•â•â• -->
<div class="ticker" id="ticker"></div>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main">
    <!-- Market Table -->
    <div class="tbl-wrap">
        <table class="mtbl">
            <thead><tr>
                <th>Typ</th>
                <th>Markt</th>
                <th class="r">Prob.</th>
                <th class="r">Î”</th>
                <th>Trend</th>
                <th>Verlauf</th>
                <th class="r">H / T</th>
                <th class="r">EU</th>
            </tr></thead>
            <tbody id="mtBody"></tbody>
        </table>
    </div>

    <!-- Right Panel -->
    <div class="rpanel">
        <!-- Scenario Impact -->
        <div class="sc-box" id="scBox">
            <div class="sc-hdr">
                <h3>Szenario-Impact</h3>
                <span class="badge" id="rBadge">#0</span>
                <span class="reason" id="rReason"></span>
            </div>
            <div class="sc-sev-row">
                <div class="sc-gauge"><canvas id="gaugeC" width="80" height="50"></canvas></div>
                <div class="sc-nums">
                    <div class="sc-num"><span class="lbl">P5</span><span class="val" id="sP5">â€”</span></div>
                    <div class="sc-num"><span class="lbl">Mean</span><span class="val" id="sMean">â€”</span></div>
                    <div class="sc-num"><span class="lbl">P95</span><span class="val" id="sP95">â€”</span></div>
                </div>
            </div>
            <div class="ib-mini" id="ibMini"><h4>Parameter Impact (P95)</h4></div>
            <div class="df-mini" id="dfMini"><h4>Disruptions</h4></div>
            <div class="stress-mini" id="stMini"></div>
        </div>

        <!-- Alert Log -->
        <div class="alog">
            <div class="alog-hdr">
                <h3>Alert Log</h3>
                <span class="alog-cnt" id="aCnt" style="background:var(--s3);color:var(--dim)">0</span>
            </div>
            <div id="aList"></div>
        </div>
    </div>
</div>

<footer>PROVIDER Pipeline â€” Polymarket (Simulated Demo)</footer>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TYPE COLORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TC = {
    geopolitical_conflict: { c:'#ef4444', bg:'#ef444422', l:'Geopolitik' },
    energy_supply:         { c:'#f59e0b', bg:'#f59e0b22', l:'Energie' },
    trade_restriction:     { c:'#f97316', bg:'#f9731622', l:'Handel' },
    transport_disruption:  { c:'#06b6d4', bg:'#06b6d422', l:'Transport' },
    agricultural_shock:    { c:'#22c55e', bg:'#22c55e22', l:'Agrar' },
    financial_crisis:      { c:'#a855f7', bg:'#a855f722', l:'Finanzen' },
    pandemic:              { c:'#ec4899', bg:'#ec489922', l:'Pandemie' },
    climate_event:         { c:'#3b82f6', bg:'#3b82f622', l:'Klima' },
    tech_disruption:       { c:'#6366f1', bg:'#6366f122', l:'Tech' },
    political_instability: { c:'#8b5cf6', bg:'#8b5cf622', l:'Polit.Stab.' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO MARKETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MARKETS = [
    { id:'ew_ukraine',     q:'Russia-Ukraine ceasefire by end of 2026?',          type:'geopolitical_conflict', rel:1.0,  base:0.44 },
    { id:'ew_china_taiwan',q:'Will China invade Taiwan before 2027?',             type:'geopolitical_conflict', rel:0.9,  base:0.13 },
    { id:'ew_eu_tariff',   q:'30% EU tariff in effect by August 2026?',           type:'trade_restriction',     rel:1.0,  base:0.35 },
    { id:'ew_recession',   q:'US recession by end of 2026?',                      type:'financial_crisis',      rel:0.9,  base:0.25 },
    { id:'ew_pandemic',    q:'New WHO-declared pandemic in 2026?',                type:'pandemic',              rel:0.9,  base:0.08 },
    { id:'ew_oil',         q:'Oil price above $80/barrel by June 2026?',          type:'energy_supply',         rel:0.9,  base:0.40 },
    { id:'ew_disaster',    q:'Major natural disaster ($50B+) in 2026?',           type:'climate_event',         rel:0.7,  base:0.30 },
    { id:'ew_rare_earth',  q:'Ukraine rare earth deal before April 2026?',        type:'tech_disruption',       rel:0.8,  base:0.55 },
    { id:'ew_brazil',      q:'Brazil agricultural export restrictions 2026?',     type:'agricultural_shock',    rel:0.9,  base:0.12 },
    { id:'ew_red_sea',     q:'Red Sea shipping disruptions through 2026?',        type:'transport_disruption',  rel:0.9,  base:0.60 },
    { id:'ew_ecb',         q:'ECB cuts rates below 2% by end of 2026?',           type:'financial_crisis',      rel:1.0,  base:0.35 },
    { id:'ew_argentina',   q:'Argentina sovereign default in 2026?',              type:'political_instability', rel:0.7,  base:0.15 },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {};
let alerts = [];
let pollCount = 0;
let paused = false;
let speed = 3;
let timer = null;
let aId = 0;
const HLEN = 40, WARN = 0.40, CRIT = 0.60;

function initState() {
    MARKETS.forEach(m => {
        S[m.id] = { ...m, prob:m.base, prev:m.base, history:[m.base], hi:m.base, lo:m.base, trend:'stable', level:'normal' };
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simTick() {
    pollCount++;
    for (const id in S) {
        const s = S[id];
        s.prev = s.prob;
        const drift = (s.base - s.prob) * 0.02;
        let noise = randn() * 0.015;
        if (Math.random() < 0.05) noise += (Math.random() < 0.5 ? -1 : 1) * (0.05 + Math.random() * 0.12);
        if (s.type === 'energy_supply') { const u=S['ew_ukraine']; if(u) noise += (u.prob-u.base)*0.3*randn()*0.4; }
        if (s.type === 'trade_restriction') { const r=S['ew_recession']; if(r) noise += (r.prob-r.base)*0.2*randn()*0.3; }
        s.prob = Math.max(0.01, Math.min(0.99, s.prob + drift + noise));
        s.history.push(s.prob);
        if (s.history.length > HLEN) s.history.shift();
        s.hi = Math.max(s.hi, s.prob);
        s.lo = Math.min(s.lo, s.prob);
        s.trend = classifyTrend(s.history);
        s.level = s.prob >= CRIT ? 'critical' : s.prob >= WARN ? 'warning' : s.prob >= 0.25 ? 'watch' : 'normal';

        // Alerts
        const pL = s.prev >= CRIT ? 'critical' : s.prev >= WARN ? 'warning' : 'normal';
        if (s.level !== pL) {
            if (s.level === 'critical') addAlert('critical','THRESHOLD',s.id,s.q,s.type,`KRITISCH: P > ${(CRIT*100)|0}% (${(s.prob*100).toFixed(1)}%)`);
            else if (s.level === 'warning' && pL === 'normal') addAlert('warning','THRESHOLD',s.id,s.q,s.type,`Warnung: P > ${(WARN*100)|0}% (${(s.prob*100).toFixed(1)}%)`);
        }
        const chg = Math.abs(s.prob - s.prev);
        if (chg >= 0.08) addAlert('warning','RAPID_SHIFT',s.id,s.q,s.type,`${(chg*100).toFixed(1)}% ${s.prob>s.prev?'â†‘':'â†“'} in letztem Tick`);
        if (s.prob >= s.hi && s.history.length > 10 && s.prob > s.base * 1.3 && Math.random()<0.3) addAlert('info','NEW_HIGH',s.id,s.q,s.type,`Allzeithoch: ${(s.prob*100).toFixed(1)}%`);
    }

    // Scenario engine
    const reason = shouldResample();
    if (reason) { runScenarios(500); lastReason = reason; }

    render();
}

function addAlert(level,type,mid,q,dtype,msg) {
    aId++;
    alerts.unshift({ id:aId, time:new Date(), level,type,mid,q,dtype,msg,tick:pollCount });
    if (alerts.length > 50) alerts.length = 50;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    const now = new Date();
    const ms = Object.values(S);
    const nC = ms.filter(m=>m.level==='critical').length;
    const nW = ms.filter(m=>m.level==='warning').length;
    const nR = ms.filter(m=>m.trend==='rising').length;
    const maxP = Math.max(...ms.map(m=>m.prob));
    const nA = alerts.filter(a=>a.level!=='info').length;

    // Header
    document.getElementById('hPoll').textContent = pollCount;
    document.getElementById('hTime').textContent = now.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

    // KPIs
    const kStat = document.getElementById('kStat');
    if (nC>0) { kStat.textContent='KRITISCH'; kStat.style.color='var(--red)'; }
    else if (nW>0) { kStat.textContent='WARNUNG'; kStat.style.color='var(--ylw)'; }
    else { kStat.textContent='NORMAL'; kStat.style.color='var(--grn)'; }
    document.getElementById('kRise').textContent = `${nR}â†‘`;
    const kMax = document.getElementById('kMax');
    kMax.textContent = (maxP*100).toFixed(1)+'%';
    kMax.style.color = maxP>=CRIT?'var(--red)':maxP>=WARN?'var(--ylw)':'var(--tx)';
    document.getElementById('kAlerts').textContent = nA;
    document.getElementById('kAlerts').style.color = nA>5?'var(--red)':nA>0?'var(--ylw)':'var(--tx)';

    // Ticker
    renderTicker();

    // Market table
    renderTable(ms);

    // Alert log
    renderAlertLog(nA);

    // Scenarios
    renderScenarioPanel();
}

function renderTicker() {
    const tk = document.getElementById('ticker');
    const recent = alerts.slice(0,3).filter(a=>a.level!=='info');
    if (recent.length === 0) { tk.innerHTML=''; tk.className='ticker'; return; }
    const topLevel = recent[0].level;
    tk.className = `ticker has-${topLevel}`;
    const icon = topLevel==='critical'?'ğŸ”´':'âš ï¸';
    tk.innerHTML = `<span class="ticker-icon">${icon}</span><span class="ticker-msgs">${recent.map(a=>`<span class="ticker-msg">${a.msg}</span>`).join('')}</span><button class="ticker-dismiss" onclick="this.parentElement.className='ticker'">&times;</button>`;
}

function renderTable(ms) {
    const sorted = [...ms].sort((a,b) => b.prob-a.prob);
    let html = '';
    sorted.forEach(m => {
        const tc = TC[m.type]||{c:'#6366f1',bg:'#6366f122',l:m.type};
        const chg = m.prob-m.prev;
        const chgAbs = (Math.abs(chg)*100).toFixed(1);
        const chgCl = chg>0.005?'up':chg<-0.005?'dn':'fl';
        const chgArr = chg>0.005?'â–²':chg<-0.005?'â–¼':'â€”';
        const pCol = m.prob>=CRIT?'var(--red)':m.prob>=WARN?'var(--ylw)':'var(--tx)';
        const rowCl = m.level==='critical'?'row-crit':m.level==='warning'?'row-warn':'';
        const tCl = `t-${m.trend}`;
        const tLbl = {rising:'â†‘',falling:'â†“',stable:'â€”',volatile:'~'}[m.trend]||'?';
        const tFull = {rising:'STEIGEND',falling:'FALLEND',stable:'STABIL',volatile:'VOLATIL'}[m.trend]||m.trend;
        // Sparkline (compact)
        const spark = m.history.map((p,i) => {
            const h = Math.max(1,p*18);
            const c = p>=CRIT?'var(--red)':p>=WARN?'var(--ylw)':'var(--grn)';
            const o = 0.3+(i/m.history.length)*0.7;
            return `<div class="b" style="height:${h}px;background:${c};opacity:${o}"></div>`;
        }).join('');

        html += `<tr class="${rowCl}">
            <td><span class="type-tag" style="background:${tc.bg};color:${tc.c}">${tc.l}</span></td>
            <td class="q-text" title="${m.q}">${m.q}</td>
            <td class="r"><span class="prob-val" style="color:${pCol}">${(m.prob*100).toFixed(1)}%</span></td>
            <td class="r"><span class="chg ${chgCl}">${chgArr}${chgAbs}</span></td>
            <td><span class="trend-pill ${tCl}" title="${tFull}">${tLbl}</span></td>
            <td><div class="spark">${spark}</div></td>
            <td class="r minmax">${(m.hi*100).toFixed(0)}/${(m.lo*100).toFixed(0)}</td>
            <td class="r" style="font-size:9px;color:var(--dim)">${(m.rel*100)|0}%</td>
        </tr>`;
    });
    document.getElementById('mtBody').innerHTML = html;
}

function renderAlertLog(nA) {
    const cEl = document.getElementById('aCnt');
    cEl.textContent = nA;
    cEl.style.background = nA>5?'var(--red)':nA>0?'var(--ylw)':'var(--s3)';
    cEl.style.color = nA>0?'white':'var(--dim)';

    const typeL = { THRESHOLD:'SCHWELLE', RAPID_SHIFT:'SHIFT', NEW_HIGH:'HOCH', CASCADE_RISK:'KASKADE' };
    document.getElementById('aList').innerHTML = alerts.slice(0,25).map(a => {
        const tCol = a.level==='critical'?'var(--red)':a.level==='warning'?'var(--ylw)':'var(--cyn)';
        return `<div class="al-item ${a.level}">
            <div class="al-top">
                <span class="al-time">${a.time.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span>
                <span class="al-type" style="color:${tCol}">${typeL[a.type]||a.type}</span>
            </div>
            <div class="al-msg">${a.msg}</div>
            <div class="al-mkt">${a.q}</div>
        </div>`;
    }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENARIO ENGINE (Monte Carlo in browser)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DISRUPTION_PROFILES = {
    geopolitical_conflict: [{n:'trade_corridor',b:-50,u:'%'},{n:'sanctions_impact',b:-25,u:'%'},{n:'uncertainty_index',b:2.0,u:'x'},{n:'energy_supply_risk',b:-30,u:'%'}],
    energy_supply: [{n:'energy_cost',b:1.8,u:'x'},{n:'gas_availability',b:-40,u:'%'},{n:'transport_fuel_cost',b:1.5,u:'x'}],
    trade_restriction: [{n:'import_cost',b:1.3,u:'x'},{n:'export_volume',b:-20,u:'%'},{n:'diversification_delay',b:90,u:'d'}],
    transport_disruption: [{n:'shipping_lead_time',b:2.5,u:'x'},{n:'freight_cost',b:3.0,u:'x'},{n:'route_availability',b:-30,u:'%'}],
    agricultural_shock: [{n:'soy_availability',b:-40,u:'%'},{n:'grain_price',b:1.7,u:'x'},{n:'feed_cost',b:1.6,u:'x'}],
    financial_crisis: [{n:'credit_availability',b:-30,u:'%'},{n:'demand_shock',b:-15,u:'%'},{n:'currency_volatility',b:1.5,u:'x'}],
    pandemic: [{n:'workforce_availability',b:-20,u:'%'},{n:'border_closure',b:-40,u:'%'},{n:'demand_volatility',b:2.0,u:'x'}],
    climate_event: [{n:'agricultural_yield',b:-25,u:'%'},{n:'infrastructure_damage',b:-15,u:'%'},{n:'water_availability',b:-30,u:'%'}],
    tech_disruption: [{n:'semiconductor_supply',b:-35,u:'%'},{n:'critical_mineral_cost',b:2.0,u:'x'},{n:'it_system_downtime',b:14,u:'d'}],
    political_instability: [{n:'supplier_country_risk',b:1.5,u:'x'},{n:'export_policy_unc.',b:-15,u:'%'},{n:'investment_freeze',b:-20,u:'%'}],
};

const CORR_MAP = {
    'geopolitical_conflict|energy_supply':0.7, 'geopolitical_conflict|trade_restriction':0.6,
    'geopolitical_conflict|transport_disruption':0.5, 'geopolitical_conflict|financial_crisis':0.4,
    'energy_supply|financial_crisis':0.5, 'trade_restriction|financial_crisis':0.5,
    'pandemic|transport_disruption':0.6, 'pandemic|financial_crisis':0.5,
    'climate_event|agricultural_shock':0.7, 'climate_event|transport_disruption':0.4,
    'tech_disruption|trade_restriction':0.4, 'political_instability|trade_restriction':0.5,
    'political_instability|agricultural_shock':0.4,
};
function gc(a,b){ return a===b?1:CORR_MAP[a+'|'+b]||CORR_MAP[b+'|'+a]||0.05; }

let scStats=null, stressScens=[], resCnt=0, lastResTick=0, lastSP={}, lastReason='';

function shouldResample() {
    if (resCnt===0) return 'Erster Lauf';
    if (alerts.find(a=>a.level==='critical'&&(pollCount-a.tick)<2)) return 'Kritischer Alert';
    let md=0;
    for (const id in S) if(id in lastSP) md=Math.max(md,Math.abs(S[id].prob-lastSP[id]));
    if (md>=0.06) return `Drift ${(md*100).toFixed(1)}%`;
    if ((pollCount-lastResTick)>=8) return 'Periodisch';
    return null;
}

function runScenarios(N) {
    const ms=Object.values(S), n=ms.length;
    if(!n) return;
    const probs=ms.map(m=>m.prob), types=ms.map(m=>m.type);
    // Correlation matrix + Cholesky
    const C=Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0;i<n;i++) for(let j=0;j<n;j++) C[i][j]=i===j?1:types[i]===types[j]?0.8:gc(types[i],types[j]);
    const L=Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0;i<n;i++) for(let j=0;j<=i;j++){
        let s=0; for(let k=0;k<j;k++) s+=L[i][k]*L[j][k];
        L[i][j]=i===j?Math.sqrt(Math.max(C[i][i]-s,0.001)):(C[i][j]-s)/(L[j][j]||0.001);
    }

    const sevs=[], tCounts={}, pSums={};
    const stBuf=[];
    for(let sc=0;sc<N;sc++){
        const z=Array(n).fill(0).map(()=>randn());
        const cz=Array(n).fill(0);
        for(let i=0;i<n;i++) for(let j=0;j<=i;j++) cz[i]+=L[i][j]*z[j];
        const u=cz.map(v=>0.5*(1+erf(v/Math.SQRT2)));
        const trig=u.map((ui,i)=>ui<probs[i]);
        const params={}, aTypes=new Set(), aQs=[];
        trig.forEach((t,i)=>{
            if(!t) return;
            aTypes.add(ms[i].type); aQs.push(ms[i].q);
            (DISRUPTION_PROFILES[ms[i].type]||[]).forEach(p=>{
                if(p.u==='x') params[p.n]=(params[p.n]||1)*p.b;
                else if(p.u==='%') params[p.n]=Math.max((params[p.n]||0)+p.b,-95);
                else params[p.n]=Math.max(params[p.n]||0,p.b);
            });
        });
        const pv=Object.entries(params);
        let ss=pv.map(([nm,val])=>{
            if(nm.includes('cost')||nm.includes('index')||nm.includes('volatility')||nm.includes('lead')||nm.includes('price'))return Math.min((Math.abs(val)-1)/2,1);
            if(nm.includes('delay')||nm.includes('downtime'))return Math.min(val/30,1);
            return Math.min(Math.abs(val)/50,1);
        }).filter(v=>v>0);
        const sev=Math.min(ss.length>0?(ss.reduce((a,b)=>a+b,0)/ss.length)+Math.min(aTypes.size*0.05,0.3):0,1);
        sevs.push(sev);
        aTypes.forEach(t=>{tCounts[t]=(tCounts[t]||0)+1;});
        for(const[k,v]of Object.entries(params)){if(!pSums[k])pSums[k]=[];pSums[k].push(Math.abs(v));}
        if(sev>=0.5) stBuf.push({sev:Math.round(sev*1000)/1000,types:[...aTypes],qs:aQs.slice(0,3),params});
    }
    sevs.sort((a,b)=>a-b);
    const mean=sevs.reduce((a,b)=>a+b,0)/N;
    const freqs={}; for(const[t,c]of Object.entries(tCounts)) freqs[t]=Math.round(c/N*1000)/10;
    const pStats={}; for(const[k,vals]of Object.entries(pSums)){ vals.sort((a,b)=>a-b); pStats[k]={mean:Math.round(vals.reduce((a,b)=>a+b,0)/vals.length*10)/10,p95:Math.round(vals[Math.floor(vals.length*0.95)]*10)/10}; }
    stBuf.sort((a,b)=>b.sev-a.sev);
    stressScens=stBuf.slice(0,6);
    scStats={mean, p5:sevs[Math.floor(N*0.05)], p50:sevs[Math.floor(N*0.5)], p95:sevs[Math.floor(N*0.95)], freqs, pStats, N};
    lastSP={}; for(const id in S) lastSP[id]=S[id].prob;
    lastResTick=pollCount; resCnt++;
}

function erf(x){const a1=.254829592,a2=-.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=.3275911;const sg=x<0?-1:1;x=Math.abs(x);const t=1/(1+p*x);return sg*(1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SCENARIO PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gChart=null;

function renderScenarioPanel() {
    if(!scStats) return;
    const s=scStats;
    document.getElementById('rBadge').textContent = `#${resCnt}`;
    document.getElementById('rReason').textContent = lastReason;
    document.getElementById('sP5').textContent = (s.p5*100).toFixed(1)+'%';
    const mEl=document.getElementById('sMean');
    mEl.textContent = (s.mean*100).toFixed(1)+'%';
    mEl.style.color = s.mean>0.6?'var(--red)':s.mean>0.4?'var(--ylw)':'var(--grn)';
    document.getElementById('sP95').textContent = (s.p95*100).toFixed(1)+'%';

    // Mini gauge
    renderGauge(s.mean);

    // Impact bars (top 6)
    const params=Object.entries(s.pStats).sort((a,b)=>b[1].p95-a[1].p95).slice(0,6);
    const mx=Math.max(...params.map(([,v])=>v.p95),1);
    let ibH='<h4>Parameter Impact (P95)</h4>';
    params.forEach(([nm,v])=>{
        const pct=(v.p95/mx)*100, pm=(v.mean/mx)*100;
        const col=v.p95>40?'var(--red)':v.p95>20?'var(--ylw)':'var(--grn)';
        ibH+=`<div class="ibm-row"><span class="ibm-lbl" title="${nm}">${nm}</span><div class="ibm-track"><div class="ibm-fill" style="width:${pm}%;background:${col};opacity:.4"></div><div class="ibm-fill-o" style="width:${pct}%;background:${col};left:0"></div></div><span class="ibm-val" style="color:${col}">${v.p95}</span></div>`;
    });
    document.getElementById('ibMini').innerHTML = ibH;

    // Disruption chips
    const freqs=Object.entries(s.freqs).sort((a,b)=>b[1]-a[1]);
    let dfH='<h4>Disruptions</h4>';
    freqs.forEach(([t,pct])=>{
        const tc=TC[t]||{c:'var(--acc)',bg:'var(--s3)',l:t};
        dfH+=`<span class="df-chip" style="background:${tc.bg};color:${tc.c}">${tc.l} <span class="pct">${pct}%</span></span>`;
    });
    document.getElementById('dfMini').innerHTML = dfH;

    // Stress strip
    let ssH='';
    stressScens.forEach(sc=>{
        const col=sc.sev>0.7?'var(--red)':'var(--ylw)';
        const tags=sc.types.map(t=>{const tc=TC[t]||{c:'#6366f1',bg:'#6366f122',l:t};return`<span style="background:${tc.bg};color:${tc.c}">${tc.l}</span>`;}).join('');
        const evts=sc.qs.map(q=>q.length>30?q.substring(0,29)+'â€¦':q).join('<br>');
        ssH+=`<div class="sm-card"><div class="sev" style="color:${col}">${(sc.sev*100).toFixed(1)}%</div><div class="tags">${tags}</div><div class="evts">${evts}</div></div>`;
    });
    document.getElementById('stMini').innerHTML = ssH;
}

function renderGauge(val) {
    if(gChart) gChart.destroy();
    const ctx=document.getElementById('gaugeC').getContext('2d');
    const col=val>0.6?'#ef4444':val>0.4?'#f59e0b':'#10b981';
    gChart=new Chart(ctx,{
        type:'doughnut',
        data:{datasets:[{data:[val,1-val],backgroundColor:[col,'#1a1e2833'],borderWidth:0,circumference:180,rotation:270}]},
        options:{responsive:false,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}}},
        plugins:[{id:'gt',afterDraw(ch){const{ctx:c,chartArea:a}=ch;c.save();c.fillStyle=col;c.font='bold 14px monospace';c.textAlign='center';c.fillText((val*100).toFixed(1)+'%',a.width/2+a.left,a.height-2);c.font='7px monospace';c.fillStyle='#6b7394';c.fillText('SEV',a.width/2+a.left,a.height+7);c.restore();}}]
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePause() {
    paused=!paused;
    const btn=document.getElementById('btnP'), dot=document.getElementById('hDot');
    if(paused){clearInterval(timer);btn.textContent='â–¶';btn.classList.add('on');dot.className='hdr-dot paused';}
    else{startLoop();btn.textContent='â¸';btn.classList.remove('on');dot.className='hdr-dot live';}
}
function setSpeed(s) {
    speed=s;
    document.querySelectorAll('.hdr-ctrl button:not(#btnP)').forEach(b=>b.classList.remove('on'));
    event.target.classList.add('on');
    if(!paused){clearInterval(timer);startLoop();}
}
function startLoop() { timer=setInterval(simTick, Math.max(200,2000/speed)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function randn(){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);}
function classifyTrend(h){if(h.length<3)return'stable';const r=h.slice(-5),d=[];for(let i=1;i<r.length;i++)d.push(r[i]-r[i-1]);const avg=d.reduce((a,b)=>a+b,0)/d.length;const vol=Math.sqrt(d.reduce((a,v)=>a+v*v,0)/d.length);if(vol>0.04)return'volatile';if(avg>0.008)return'rising';if(avg<-0.008)return'falling';return'stable';}

document.addEventListener('keydown',e=>{if(e.key===' '){e.preventDefault();togglePause();}if(e.key==='1')setSpeed(1);if(e.key==='2')setSpeed(3);if(e.key==='3')setSpeed(10);});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initState();
simTick();
startLoop();
</script>
</body>
</html>
